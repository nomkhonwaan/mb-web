version: 2
jobs:
  install:
    docker:
    - image: circleci/node:8
    working_directory: ~/repo
    steps:
    - checkout
    - run: yarn install
    - run: yarn build-css
    - save_cache:
        paths:
        - node_modules
        key: node-{{ checksum "package.json" }}
    - persist_to_workspace:
        root: ~/repo
        paths: 
        - src
  build_for_development:
    docker:
    - image: circleci/node:8
    working_directory: ~/repo
    steps:
    - checkout
    - attach_workspace:
        at: ~/repo
    - restore_cache:
        keys:
        - node-{{ checksum "package.json" }}
    - run: |
          echo 'export REACT_APP_API_URL=$API_URL_DEVELOPMENT' >> $BASH_ENV
          source $BASH_ENV
    - run: yarn build-js
    - persist_to_workspace:
        root: ~/repo
        paths: 
        - build
  build_for_staging_and_production:
    docker:
    - image: circleci/node:8
    working_directory: ~/repo
    steps:
    - checkout
    - attach_workspace:
        at: ~/repo
    - restore_cache:
        keys:
        - node-{{ checksum "package.json" }}
    - run: |
        echo 'export REACT_APP_API_URL=$API_URL_PRODUCTION' >> $BASH_ENV
        source $BASH_ENV
    - run: yarn build-js
    - persist_to_workspace:
        root: ~/repo
        paths: 
        - build
  test:
    docker:
    - image: circleci/node:8
    working_directory: ~/repo
    steps:
    - checkout
    - attach_workspace:
        at: ~/repo
    - restore_cache:
        keys:
        - node-{{ checksum "package.json" }}
    - run: yarn test
  deploy_to_production:
    docker:
    - image: circleci/node:8
    working_directory: ~/repo
    steps:
    - checkout
    - attach_workspace:
        at: ~/repo
    - restore_cache:
        keys:
        - node-{{ checksum "package.json" }}
    - run: yarn firebase use production --token=$FIREBASE_TOKEN
    - run: yarn firebase deploy --token=$FIREBASE_TOKEN
  deploy_to_staging:
    docker:
    - image: circleci/node:8
    working_directory: ~/repo
    steps:
    - checkout
    - attach_workspace:
        at: ~/repo
    - restore_cache:
        keys:
        - node-{{ checksum "package.json" }}
    - run: yarn firebase use staging --token=$FIREBASE_TOKEN
    - run: yarn firebase deploy --token=$FIREBASE_TOKEN
  deploy_to_development:
    docker:
    - image: circleci/node:8
    working_directory: ~/repo
    steps:
    - checkout
    - attach_workspace:
        at: ~/repo
    - restore_cache:
        keys:
        - node-{{ checksum "package.json" }}
    - run: yarn firebase use development --token=$FIREBASE_TOKEN
    - run: yarn firebase deploy --token=$FIREBASE_TOKEN
workflows:
  version: 2
  test_build_and_deploy:
    jobs:
    - install
    - test:
        requires: 
        - install
    - build_for_development:
        requires:
        - test
        filters:
          branches:
            ignore: master
    - build_for_staging_and_production:
        requires:
        - test
        filters:
          branches:
            only: master
    - hold:
        type: approval
        filters:
          branches:
            only:
            - master
    - deploy_to_development:
        requires:
        - build_for_development
        filters:
          branches:
            ignore: master
    - deploy_to_staging:
        requires:
        - build_for_staging_and_production
        filters:
          branches:
            only: master
    - deploy_to_production:
        requires:
        - build_for_staging_and_production
        - hold
        filters:
          branches:
            only: master
